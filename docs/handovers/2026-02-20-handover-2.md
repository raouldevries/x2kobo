# Session Handover — 2026-02-20 (Session 2)

## Session Goal

First real-world test of x2kobo: install Chromium, run the full conversion pipeline against a live X Article, and fix issues discovered during testing.

## What Was Done

- Installed Playwright Chromium browser
- Attempted X login via Playwright — blocked by X bot detection
- Switched to system Chrome (`channel: "chrome"`) to bypass detection
- Added `--use-chrome` CLI flag for using existing Chrome profile
- Tested full pipeline with real article: `https://x.com/AtlasForgeAI/article/2021773566341988758`
- Fixed title extraction — was returning "X" (page title), now reads from `[data-testid="twitter-article-title"]`
- Fixed handle extraction — now parsed from URL instead of guessing from page links
- Fixed author lookup — matches against the handle's profile link
- Fixed image extraction — article cover images from `tweetPhoto` containers were being stripped by Readability
- Fixed KEPUB XHTML parsing — switched from strict `application/xhtml+xml` to lenient `text/html` parsing

## Key Decisions

| # | Decision | Choice | Rationale |
|---|----------|--------|-----------|
| 1 | Browser engine | System Chrome via `channel: "chrome"` | Playwright's bundled Chromium is blocked by X's bot detection |
| 2 | Title extraction | DOM element `[data-testid="twitter-article-title"]` | `page.title()` returns "X", not the article title |
| 3 | Handle source | Parse from URL (`x.com/<handle>/article/...`) | Most reliable — page links can match wrong users mentioned in article |
| 4 | Image injection | Extract `tweetPhoto` imgs from `twitterArticleReadView`, inject into body HTML | Readability strips images that are siblings of the rich text content |
| 5 | KEPUB parsing | `text/html` content type instead of `application/xhtml+xml` | Readability output is HTML5, not strict XHTML — causes parse errors |

## Files Changed

- `src/extractor/browser.ts` — modified — Use system Chrome, add `useSystemChrome` option, cross-platform profile paths
- `src/extractor/article.ts` — modified — Thread `useSystemChrome` option through `loadArticle`
- `src/extractor/metadata.ts` — modified — New title/handle/author extraction, image injection from `tweetPhoto`
- `src/generator/kepub.ts` — modified — Parse as HTML instead of strict XHTML
- `src/cli.ts` — modified — Add `--use-chrome` flag to convert and default commands
- `src/commands/convert.ts` — modified — Pass `useChrome` option through to `loadArticle`
- `src/extractor/browser.test.ts` — modified — Update expectations for `channel: "chrome"`
- `src/extractor/metadata.test.ts` — modified — Update handle expectation for URL-based extraction
- `src/commands/convert.test.ts` — modified — Update `loadArticle` call expectation

## Current State

- **Tests:** 92 passed, 0 failed across 15 test files
- **Build:** Clean — zero TypeScript errors
- **Lint:** Clean
- **Real-world test:** Successfully converted live X Article to KEPUB (355.6 KB with embedded image)
- **Known Issues:**
  - `Could not parse CSS stylesheet` warnings from JSDOM (cosmetic, doesn't affect output)
  - `--use-chrome` flag hangs when pointed at full Chrome profile (too heavyweight) — works fine without it since articles are publicly accessible
  - Login via Playwright still blocked by X bot detection (not needed for public articles)

## Next Steps

- [ ] Transfer KEPUB to Kobo device and validate rendering
- [ ] Create Dropbox app at developers.dropbox.com, then `npx x2kobo auth`
- [ ] Test Dropbox upload end-to-end
- [ ] `gh repo create` + `git push`
- [ ] Test with more article URLs to verify extraction robustness

## Blockers

- None. Pipeline works end-to-end for public X Articles.
