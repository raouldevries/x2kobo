# Session Handover — 2026-02-21

## Session Goal
Implement batch conversion + config defaults (from session 6 backlog), close the `serve` PR, and set up iOS Shortcut → SSH workflow for converting articles from phone.

## What Was Done
- Implemented batch conversion: `x2kobo <url1> <url2>` converts multiple articles reusing the browser
- Implemented config defaults: `x2kobo config set noUpload true` persists preferences across runs
- Reviewed and closed PR #1 (web server approach) in favor of iOS Shortcuts + SSH
- Cloned x2kobo on Mac Mini (`mini`), installed Playwright, copied X session + Dropbox tokens
- Created `~/bin/x2kobo` wrapper script on mini for clean SSH invocation
- Created "Send to Kobo" iOS Shortcut with Run Script Over SSH action
- Testing blocked: mini is at the office, phone can't reach it without Tailscale

## Key Decisions

| # | Decision | Choice | Rationale |
|---|----------|--------|-----------|
| 1 | Server vs SSH for phone integration | SSH (close PR #1) | Zero new code, same result, no security surface |
| 2 | Where to run conversions | Mac Mini | Always-on machine, already has the project cloned |
| 3 | Tailscale for remote access | Deferred | Mini is coming home next week, won't need it on home Wi-Fi |

## Files Changed
- `src/config/store.ts` — modified — Added `UserDefaults` interface, `getUserDefaults()`, `saveUserDefaults()`
- `src/config/merge.ts` — NEW — `mergeOptions()` utility (CLI flags override config defaults)
- `src/config/merge.test.ts` — NEW — Tests for merge utility
- `src/commands/config.ts` — NEW — `config set/get/list/reset` subcommands
- `src/commands/config.test.ts` — NEW — Tests for config commands
- `src/commands/batch.ts` — NEW — `convertBatch()` orchestrator with continue-on-error
- `src/commands/batch.test.ts` — NEW — Tests for batch orchestrator
- `src/commands/convert.ts` — modified — Added `keepBrowserOpen` option, guarded `closeBrowser()` calls
- `src/commands/convert.test.ts` — modified — Tests for keepBrowserOpen behavior
- `src/utils/logger.ts` — modified — Added `printBatchSummary()`
- `src/cli.ts` — modified — Variadic URLs, config subcommand, `resolveConvertOptions()` with `getOptionValueSource()`
- `src/cli.test.ts` — modified — Tests for variadic args and config subcommand
- `src/config/store.test.ts` — modified — Tests for UserDefaults persistence

## Current State
- **Tests:** 119 passing (up from 89)
- **Build:** Clean
- **Known Issues:** None in code

## Setup on Mac Mini
- x2kobo cloned at `~/Work/Apps/X Article to Kobo/`
- Wrapper script at `~/bin/x2kobo`
- Browser session + Dropbox tokens copied from MacBook to `~/.x2kobo/`
- Playwright Chromium installed
- `x2kobo status` confirms: X session found, Dropbox token will auto-refresh
- Tailscale IP: `100.74.227.11` (if needed remotely)

## Next Steps
- [ ] Once mini is on home Wi-Fi: get its local IP, update iOS Shortcut Host field, test end-to-end
- [ ] If mDNS works reliably from iOS: use `mini.local` as host instead of IP
- [ ] Consider assigning mini a static IP / DHCP reservation for stability
- [ ] Test batch from shortcut: share multiple URLs at once

## Blockers
- Mini is at the office until next week — can't test iOS Shortcut → SSH flow until it's on home network
